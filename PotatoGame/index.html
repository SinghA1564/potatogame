<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>

    var config = {
        type: Phaser.AUTO,
        width: window.innerWidth-30, //1200
        height: window.innerHeight, //700
        physics: {
            default: 'arcade',
        },
<<<<<<< HEAD
=======

>>>>>>> 7d53788076db8351c4b726ceda95079648364bfd
        scene: {
            preload: preload,
            create: create,
            update: update,
        }

    };

    class Player extends Phaser.Physics.Arcade.Sprite
    {
<<<<<<< HEAD
        totalJumps = 1000;
=======
        lastCheckpoint;
        totalJumps = 2;
>>>>>>> 7d53788076db8351c4b726ceda95079648364bfd
        currentJumps = 0;
        constructor(scene, x, y)
        {
            super(scene, x, y, 'player');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(false);
            this.setGravityY(3000); //We will set gravity *per object* rather than for the scene!
            
        }
    }

    class Checkpoint extends Phaser.Physics.Arcade.Sprite{
      x;
      y;
      constructor(scene, x, y){
          super(scene, x, y, 'checkFlag');
          scene.add.existing(this);
          scene.physics.add.existing(this);
          this.setScale(0.25);
          this.x = x;
          this.y = y;
          checkpoints.push(this);
      }
    }

    var game = new Phaser.Game(config);

    //Game Objects
    var platforms; 
    var skys;
    var player;
<<<<<<< HEAD
    var collapsingPlatforms;
=======
    var checkpoints = [];
>>>>>>> 7d53788076db8351c4b726ceda95079648364bfd

    //Keyboard controls
    var cursors;
    var keys;
    var space;
    var LavaPlatform
    var camera

    //var newCamera = new camera(0, 0, 1000, 1000)
    //this.game.camera = newCamera

    //var newCam = this.cameras.main


    function preload()
    {
        this.load.image('sky', 'assets/clouds.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('player', 'assets/wabbit.png');
        this.load.image('lava', 'assets/lava.png');
<<<<<<< HEAD
        this.load.image('collapsing-platform','assets/rock_platform.png')
=======
        this.load.image('checkFlag', 'assets//checkpoint_flag_solidgreen.png')
>>>>>>> 7d53788076db8351c4b726ceda95079648364bfd
    }

    function create()
    {
        camera = this.cameras.main;
        //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
       let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, 'sky').setOrigin(0, 0);


       //Create the platforms and the player character set to collide with the platforms
       createPlatforms(this);
       player = new Player(this, 235, 13900);
       this.physics.add.collider(player, platforms);
       player2 = new Player(this, 235+(game.scale.width/2), 13900);
       this.physics.add.collider(player2, platforms);

<<<<<<< HEAD
       //Create collapsing platform
       collapsingPlatforms = this.physics.add.staticGroup();
       collapsingPlatforms.create(1000,7000, 'collapsing-platform');
       collapsingPlatforms.create(500,5000,'collapsing-platform');
       collapsingPlatforms.create(400, 6000,'collapsing-platform');
       this.physics.add.collider(player,collapsingPlatforms,shakePlatform,checkOneWay,this);
       this.physics.add.collider(player2,collapsingPlatforms,shakePlatform,checkOneWay,this);
=======
       //Init static starting checkpoints
       let checkpoint1 = new Checkpoint(this, player.x, player.y);
       let checkpoint2 = new Checkpoint(this, player2.x, player2.y);
       checkpoint1.disableBody(true, true);
       player.lastCheckpoint = checkpoint1;
       checkpoint2.disableBody(true, true);
       player2.lastCheckpoint = checkpoint2;

       //Set player collision with checkpoints
       this.physics.add.overlap(player, checkpoints, setCheckpoint);
       this.physics.add.overlap(player2, checkpoints, setCheckpoint);

       //Set lava plat physics
       this.physics.add.collider(player, LavaPlatform, playerInLava);
       this.physics.add.collider(player2, LavaPlatform, playerInLava);
>>>>>>> 7d53788076db8351c4b726ceda95079648364bfd

       //Set up user input
       cursors = this.input.keyboard.createCursorKeys();
       keys = this.input.keyboard.addKeys('A, D');
       space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
       space.on('down', jump); //calls jump function when space is pressed
       uparrow = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
       uparrow.on('down', jump2);
       camera.width = game.scale.width // 1200 
       camera.height = 14000

       player.setScale(1, 1).refreshBody();
       player2.setScale(1, 1).refreshBody();
       camera.y = -13700
    }

    function createPlatforms(scene)
    {
        platforms = scene.physics.add.staticGroup();
        lava = scene.physics.add.staticGroup();
        skys = scene.physics.add.staticGroup();

        //basePlatform is the floor of the game
        for (let i=1; i < 100; i++) {
            skys.create(400, i*800+300, 'sky');
            skys.create(1215, i*800+300, 'sky');
        }
        let basePlatform = platforms.create(game.scale.width/2, 14000, 'platform');
        basePlatform.setScale(10, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor

        LavaPlatform = lava.create(game.scale.width/2, 15000, 'lava');
        LavaPlatform.setScale(10, 30).refreshBody(); //scales the base platform in the x axis to cover the entire floor
        //
        let wallPlatform = platforms.create(game.scale.width/2, 13000, 'platform');
        wallPlatform.setScale(0.15, 1000).refreshBody(); //scales the base platform in the x axis to cover the entire floor

        let wallPlatformRight = platforms.create(game.scale.width+40, 13000, 'platform');
        wallPlatformRight.setScale(0.15, 1000).refreshBody();

        let wallPlatformLeft = platforms.create(-40, 13000, 'platform');
        wallPlatformLeft.setScale(0.15, 1000).refreshBody();

        platforms.create(250, 350, 'platform'); //creates the upper left platform
        platforms.create(950, 500, 'platform'); //creates the bottome right platform
        let platsizeloc =  200
        for (let i=2; i < 46*2.5; i++) { // player 1 platforms
            let plateRandom
            if (platsizeloc == 100) {
                plateRandom = Phaser.Math.FloatBetween(2,1)*150
            } else if (platsizeloc == game.scale.width/2-100) {
                plateRandom = Phaser.Math.FloatBetween(-2,-1)*150
            } else {
                plateRandom = Phaser.Math.FloatBetween(-2,2)*150
            }
            platsizeloc =  platsizeloc+plateRandom
            if (platsizeloc > game.scale.width/2-100) {
                platsizeloc = game.scale.width/2-100
            }
            if (platsizeloc < 100) {
                platsizeloc = 100
            }
            let platform1 = platforms.create(platsizeloc, i*150+350, 'platform'); //creates the upper left platform

            //Add a checkpoint on every 10 platforms
            if(i % 10 == 0){ // Mod number adjusts plaform check freq.
              let checkpoint1 = new Checkpoint(scene, platsizeloc, i*150+350 - 45);
            }
            
            platform1.setScale(0.2, 0.5).refreshBody();
        }
        platsizeloc =  200
        for (let i=2; i < 46*2.5; i++) { // player 2 platforms
            let plateRandom
            if (platsizeloc == 100) {
                plateRandom = Phaser.Math.FloatBetween(2,1)*150
            } else if (platsizeloc == game.scale.width/2-100) {
                plateRandom = Phaser.Math.FloatBetween(-2,-1)*150
            } else {
                plateRandom = Phaser.Math.FloatBetween(-2,2)*150
            }
            platsizeloc =  platsizeloc+plateRandom
            if (platsizeloc > game.scale.width/2-100) {
                platsizeloc = game.scale.width/2-100
            }
            if (platsizeloc < 100) {
                platsizeloc = 100
            }
            let platform1 = platforms.create(platsizeloc+(game.scale.width/2), i*150+350, 'platform'); //creates the upper left platform

            //Add a checkpoint on every 10 platforms
            if(i % 10 == 0){ // Mod number adjusts plaform check freq.
              let checkpoint2 = new Checkpoint(scene, platsizeloc+(game.scale.width/2), i*150+350 - 45);
            }

            platform1.setScale(0.2, 0.5).refreshBody();
        }
        //LavaPlatform.BringToTop()
    }
    
    function checkOneWay(player, oneway) {
  //if player is higher up the screen then the plaform then enable the collision
      if (player.y < oneway.y) {
        return true;
      }
  //otherwise disable collision
      return false;
    }
    
    function shakePlatform(player, platform) {
    //only make platform shake if player is standing on it
      if (player.body.blocked.down) {
        //we need to store the global scope here so we can keep it later
        var ourScene = this;
        //do a yoyo tween shaking the platform back and forth and up and down
        var tween = this.tweens.add({
            targets: platform,
            yoyo: true,
            repeat: 10,
            x: {
                from: platform.x,
                to: platform.x + 2 * 1,
            },
            ease: 'Linear',
            duration: 50,
            onComplete: function() {
                destroyPlatform.call(ourScene, platform);
            }
        });
      }
    }
    
    function destroyPlatform(platform) {
     var tween = this.tweens.add({
        targets: platform,
        alpha: 0,
        y: "+=25",
        ease: 'Linear',
        duration: 100,
        onComplete: function() {
            destroyGameObject(platform);
        }
      });
    }

    function destroyGameObject(gameObject) {
      gameObject.destroy();
    }

    function update()
    {
        LavaPlatform.y = LavaPlatform.y - 0.3
        LavaPlatform.refreshBody();
        //Player will not move in the x-axis unless a movement key is being pressed
        player.setVelocityX(0);
        player2.setVelocityX(0);

        //Player has "drag" on the x-axis meaning they slide a bit after an input
        player.setDragX(1000);
        player2.setDragX(1000);

        //When the player lands on the ground, reset currentJumps to 0
        if (player.body.touching.down)
        {
            player.currentJumps = 0;
        }
        if (player2.body.touching.down)
        {
            player2.currentJumps = 0;
        }

        //Handle player movements
        if (keys.A.isDown)
        {
            player.setVelocityX(-400);
        }
        if (cursors.left.isDown)
        {
            player2.setVelocityX(-400);
        }

        if (keys.D.isDown)
        {
            player.setVelocityX(400);
        }
        if (cursors.right.isDown)
        {
            player2.setVelocityX(400);
        }
        // 100 > 200 200-100 100/2
        //console.log("y: "+ player.y + "x: " + player.x)
        if (player.y > player2.y) {
            camera.y = camera.y+(((player.y*-1)+500)-camera.y)/10
        } else {
            camera.y = camera.y+(((player2.y*-1)+500)-camera.y)/10
        }
    }

    function jump(event)
    {
        if (player.body.touching.down)
        {
            player.setVelocityY(-800);
            player.currentJumps++; //~ player.currentJumps = player.currentJumps + 1
        }
        else if (player.currentJumps < player.totalJumps)
        {
            player.setVelocityY(-700);
            player.currentJumps++;
        }
    }
    function jump2(event)
    {
        if (player2.body.touching.down)
        {
            player2.setVelocityY(-800);
            player2.currentJumps++; //~ player.currentJumps = player.currentJumps + 1
        }
        else if (player2.currentJumps < player2.totalJumps)
        {
            player2.setVelocityY(-700);
            player2.currentJumps++;
        }
    }

    function setCheckpoint(player, checkpoint){
      player.lastCheckpoint = checkpoint;
      console.log("last is reset. x = " + checkpoint.x);
      console.log("y = "  + checkpoint.y)
    }

    function playerInLava(player){
      console.log("dead");
      player.x = player.lastCheckpoint.x;
      player.y = player.lastCheckpoint.y;
    }

    </script>

</body>

</html>
